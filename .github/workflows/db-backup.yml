# .github/workflows/db_backup.yml
name: Nightly Postgres Backup to R2

on:
  schedule:
    - cron: "0 1 * * *" # 01:00 UTC daily
  workflow_dispatch: {}

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PostgreSQL client + AWS CLI
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          sudo apt-get install -y awscli

      - name: Run backup + upload to R2
        env:
          BACKUP_DATABASE_URL: ${{ secrets.BACKUP_DATABASE_URL }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_PREFIX: ${{ secrets.R2_PREFIX }}
        run: |
          set -euo pipefail
          bash scripts/backup_db_to_r2.sh
