# .github/workflows/backup-verify.yml
name: Monthly Backup Restore Verification

on:
  schedule:
    - cron: "0 2 1 * *"  # 1st of every month at 2 AM UTC
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U testuser"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Install PostgreSQL client 18
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client-18

      - name: Ensure AWS CLI is available
        run: |
          set -euo pipefail
          if command -v aws >/dev/null 2>&1; then
            aws --version
            exit 0
          fi
          curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install

      - name: Download latest backup from R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          set -euo pipefail
          ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"

          LATEST=$(aws s3 ls "s3://${R2_BUCKET}/" --endpoint-url "$ENDPOINT" \
            | awk '{print $4}' \
            | sort \
            | tail -n 1)

          echo "Latest backup: $LATEST"
          aws s3 cp "s3://${R2_BUCKET}/${LATEST}" ./latest.dump --endpoint-url "$ENDPOINT"

      - name: Restore dump into temporary database
        run: |
          set -euo pipefail
          PGPASSWORD=testpass /usr/lib/postgresql/18/bin/pg_restore \
            -h localhost \
            -U testuser \
            -d testdb \
            ./latest.dump

      - name: Verify restore (basic validation)
        run: |
          set -euo pipefail
          PGPASSWORD=testpass psql -h localhost -U testuser -d testdb -c "\dt"

          echo "Backup restore verification successful."
